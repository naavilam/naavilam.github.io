---
layout: page
permalink: /audit.html
title: Audit
description: Internal repository report
---

<style>
    /* intencionalmente feio/mono, mas sem quebrar o layout do site */
    .audit-wrap {
        font-family: ui-monospace, Menlo, Consolas, monospace;
    }

    .audit-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin: 10px 0 14px;
    }

    .audit-row input,
    .audit-row select {
        max-width: 100%;
        padding: 6px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
    }

    .audit-row input {
        width: 320px;
    }

    .audit-row select {
        width: 360px;
    }

    .audit-muted {
        color: #444;
        font-size: 12px;
    }

    .audit-table {
        border-collapse: collapse;
        width: 100%;
    }

    .audit-table th,
    .audit-table td {
        border: 1px solid #000;
        padding: 6px 8px;
        font-size: 12px;
        vertical-align: top;
    }

    .audit-table th {
        background: #f2f2f2;
    }

    .audit-ok {
        background: #eaffea;
    }

    .audit-no {
        background: #ffecec;
    }

    .audit-row button {
        padding: 6px 10px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
    }

    .audit-row button:disabled {
        opacity: .5;
        cursor: not-allowed;
    }

    /* === PIN fancy (minimal) === */
    .pin-wrap {
        display: inline-flex;
        align-items: center;
        padding: 6px 8px;
        border: 1px solid #000;
        cursor: text;
    }

    .pin-dots {
        display: flex;
        gap: 6px;
    }

    .pin-dots .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
    }

    .pin-dots .dot.filled {
        background: #000;
    }

    #pin-hidden {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
</style>

<div class="audit-wrap">
    <div class="audit-muted">internal report (minimal by design)</div>

    <div class="audit-row">
        <label class="audit-muted">org:</label>
        <select id="orgSelect">
            <option>loading…</option>
        </select>

        <label class="audit-muted">filter:</label>
        <input id="q" placeholder="type repo name..." />

        <span id="stats" class="audit-muted"></span>
        <button id="btnRunAudit" type="button">run org audit</button>
        <button id="btnInitRepos" type="button">init repos (selected org)</button>
        <button id="btnLoadDiagrams" type="button">diagrams</button>
        <div id="pin-wrap" class="pin-wrap" tabindex="0" title="operator pin">
            <div class="pin-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <input id="pin-hidden" type="password" inputmode="numeric" autocomplete="off">
        </div>
        <span id="actionMsg" class="audit-muted"></span>
    </div>

    <table class="audit-table">
        <thead>
            <tr>
                <th>Repo</th>
                <th>README</th>
                <th>.gitignore</th>
                <th>branches</th>
                <th>ipynb</th>
                <th>py</th>
                <th>tex</th>
                <th>files</th>
                <th>updated</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td colspan="9">loading…</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    const INDEX_URL = "{{ '/reports/index.json' | relative_url }}";
    const DISPATCH_API = "{{ '/api/github/dispatch' | relative_url }}";

    const tbody = document.getElementById("tbody");
    const q = document.getElementById("q");
    const stats = document.getElementById("stats");
    const orgSelect = document.getElementById("orgSelect");

    let rows = [];
    let currentOrg = null;

    function td(text, cls = "") {
        const el = document.createElement("td");
        el.textContent = text;
        if (cls) el.className = cls;
        return el;
    }

    function scoreRow(x) {
        // Primeiro os que “faltam” coisas
        return (x.has_readme ? 0 : 2) + (x.has_gitignore ? 0 : 1);
    }

    function render() {
        const needle = (q.value || "").trim().toLowerCase();
        const filtered = needle
            ? rows.filter(r =>
                (r.name || "").toLowerCase().includes(needle) ||
                (r.full_name || "").toLowerCase().includes(needle)
            )
            : rows;

        const total = rows.length;
        const shown = filtered.length;
        const withReadme = filtered.filter(r => r.has_readme).length;
        const withGitignore = filtered.filter(r => r.has_gitignore).length;
        const ipynb = filtered.reduce((s, r) => s + (r.notebooks_ipynb || 0), 0);

        stats.textContent =
            `org=${currentOrg || "—"} | showing ${shown}/${total} | README ${withReadme} | gitignore ${withGitignore} | ipynb ${ipynb}`;

        tbody.innerHTML = "";

        if (!filtered.length) {
            const tr = document.createElement("tr");
            tr.appendChild(td("no repos found"));
            for (let i = 0; i < 8; i++) tr.appendChild(td(""));
            tbody.appendChild(tr);
            return;
        }

        for (const r of filtered) {
            const tr = document.createElement("tr");

            const repoCell = document.createElement("td");
            const a = document.createElement("a");
            a.href = r.url;
            a.textContent = r.name;
            a.target = "_blank";
            a.rel = "noreferrer";
            repoCell.appendChild(a);
            tr.appendChild(repoCell);

            tr.appendChild(td(r.has_readme ? "yes" : "no", r.has_readme ? "audit-ok" : "audit-no"));
            tr.appendChild(td(r.has_gitignore ? "yes" : "no", r.has_gitignore ? "audit-ok" : "audit-no"));
            tr.appendChild(td(String(r.branches_count || 0)));
            tr.appendChild(td(String(r.notebooks_ipynb || 0)));
            tr.appendChild(td(String(r.files_py || 0)));
            tr.appendChild(td(String(r.files_tex || 0)));
            tr.appendChild(td(String(r.total_files || 0)));
            tr.appendChild(td((r.pushed_at || "").slice(0, 10)));

            tbody.appendChild(tr);
        }
    }

    function loadOrg(org) {
        currentOrg = org;
        const DATA_URL = `{{ '/reports/' | relative_url }}${org}/org-audit.json`;

        tbody.innerHTML = `<tr><td colspan="9">loading ${org}…</td></tr>`;
        q.value = "";

        fetch(DATA_URL, { cache: "no-store" })
            .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
            .then(data => {
                rows = data || [];
                rows.sort((a, b) => scoreRow(b) - scoreRow(a) || (a.name || "").localeCompare(b.name || ""));
                render();
                // salva escolha
                try { localStorage.setItem("audit_org", org); } catch (_) { }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="9">failed to load ${DATA_URL}: ${String(err)}</td></tr>`;
            });
    }

    q.addEventListener("input", render);

    fetch(INDEX_URL, { cache: "no-store" })
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(idx => {
            const orgs = (idx && idx.orgs) ? idx.orgs : [];
            orgSelect.innerHTML = "";

            if (!orgs.length) {
                orgSelect.innerHTML = `<option>(no orgs in index.json)</option>`;
                tbody.innerHTML = `<tr><td colspan="9">reports/index.json has no orgs</td></tr>`;
                return;
            }

            for (const org of orgs) {
                const opt = document.createElement("option");
                opt.value = org;
                opt.textContent = org;
                orgSelect.appendChild(opt);
            }

            // escolhe org (localStorage -> primeira)
            let preferred = null;
            try { preferred = localStorage.getItem("audit_org"); } catch (_) { }
            const initial = (preferred && orgs.includes(preferred)) ? preferred : orgs[0];

            orgSelect.value = initial;
            loadOrg(initial);
        })
        .catch(err => {
            tbody.innerHTML = `<tr><td colspan="9">failed to load ${INDEX_URL}: ${String(err)}</td></tr>`;
        });

    orgSelect.addEventListener("change", () => loadOrg(orgSelect.value));

    const btnRunAudit = document.getElementById("btnRunAudit");
    const btnInitRepos = document.getElementById("btnInitRepos");
    const btnLoadDiagrams = document.getElementById("btnLoadDiagrams");
    const actionMsg = document.getElementById("actionMsg");

    function setBusy(busy, msg = "") {
        btnRunAudit.disabled = busy;
        btnInitRepos.disabled = busy;
        actionMsg.textContent = msg || "";
    }

    async function postJSON(url, payload) {
        const r = await fetch(url, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
        });
        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) { }
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text || r.statusText}`);
        return data;
    }

    // 1) Dispara auditoria (ex: workflow org-audit no repo central "hub" ou ".github")
    btnRunAudit?.addEventListener("click", async () => {
        try {
            setBusy(true, "dispatching org audit…");

            // Ajuste para o seu repo central que contém o workflow org-audit.yml
            // Ex: org=naavilam, repo=hub, workflow=org-audit.yml
            const payload = {
                action: "workflow_dispatch",
                org: "naavilam",
                repo: "hub",
                workflow: "org-audit.yml",
                ref: "main",
                inputs: {},
                pin: window.getOperatorPin()
            };

            if ((window.getOperatorPin() || "").length !== 4) {
                setBusy(false, "enter 4-digit pin");
                return;
            }
            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();

            setBusy(false, out?.message || "ok: audit dispatched");
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    // 2) Dispara inicializa-repos.yml no .github da org selecionada
    btnInitRepos?.addEventListener("click", async () => {
        try {
            const org = orgSelect.value;
            if (!org) return;

            setBusy(true, `dispatching inicializa-repos for ${org}…`);

            const payload = {
                action: "workflow_dispatch",
                org,                // org selecionada na UI
                repo: ".github",    // workflow está em org/.github
                workflow: "inicializa-repos.yml",
                ref: "main",
                inputs: {
                    mode: "all",
                    org: org,
                    repo: ""          // porque seu workflow aceita repo quando mode=one
                }
            };

            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();
            setBusy(false, out?.message || `ok: inicializa-repos dispatched for ${org}`);
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    btnLoadDiagrams?.addEventListener("click", async () => {
        window.location.href = "./svg-gallery.html";
    });

    // === PIN fancy logic (isolado) ===
    (() => {
        const wrap = document.getElementById("pin-wrap");
        const input = document.getElementById("pin-hidden");
        if (!wrap || !input) return;

        const dots = [...wrap.querySelectorAll(".dot")];
        const MAX = dots.length;

        function renderPin() {
            dots.forEach((d, i) =>
                d.classList.toggle("filled", i < input.value.length)
            );
        }

        wrap.addEventListener("click", () => input.focus());

        input.addEventListener("input", () => {
            input.value = input.value.replace(/\D/g, "").slice(0, MAX);
            renderPin();
        });

        input.addEventListener("keydown", e => {
            if (e.key === "Backspace") {
                input.value = input.value.slice(0, -1);
                renderPin();
                e.preventDefault();
            }
        });

        window.getOperatorPin = () => input.value;

        window.resetOperatorPin = () => {
            input.value = "";
            dots.forEach(d => d.classList.remove("filled"));
            input.blur();
        };
    })();
</script>