---
layout: page
permalink: /audit.html
title: Audit
description: Internal repository report
---

<style>
    /* intencionalmente feio/mono, mas sem quebrar o layout do site */
    .audit-wrap {
        font-family: ui-monospace, Menlo, Consolas, monospace;
    }

    .audit-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin: 10px 0 14px;
    }

    .audit-row input,
    .audit-row select {
        max-width: 100%;
        padding: 6px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
    }

    .audit-row input {
        width: 320px;
    }

    .audit-row select {
        width: 360px;
    }

    .audit-muted {
        color: #444;
        font-size: 12px;
    }

    .audit-table {
        border-collapse: collapse;
        width: 100%;
    }

    .audit-table th,
    .audit-table td {
        border: 1px solid #000;
        padding: 6px 8px;
        font-size: 12px;
        vertical-align: top;
    }

    .audit-table th {
        background: #f2f2f2;
    }

    .audit-ok {
        background: #eaffea;
    }

    .audit-no {
        background: #ffecec;
    }

    .audit-row button {
        padding: 6px 10px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
    }

    .audit-row button:disabled {
        opacity: .5;
        cursor: not-allowed;
    }

    /* === PIN fancy (minimal) === */
    .pin-wrap {
        display: inline-flex;
        align-items: center;
        padding: 6px 8px;
        border: 1px solid #000;
        cursor: text;
    }

    .pin-dots {
        display: flex;
        gap: 6px;
    }

    .pin-dots .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
    }

    .pin-dots .dot.filled {
        background: #000;
    }

    #pin-hidden {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .pin-wrap {
        display: none;
        /* override do inline-flex */
    }

    .pin-wrap.is-open {
        display: inline-flex;
    }

    .audit-radio {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        margin-left: 10px;
    }

    .audit-radio label {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .audit-radio input[type="radio"] {
        transform: translateY(1px);
    }

    .audit-table th {
        cursor: pointer;
        user-select: none;
    }

    .audit-table th.sort-asc::after {
        content: " ↑";
        opacity: 0.6;
    }

    .audit-table th.sort-desc::after {
        content: " ↓";
        opacity: 0.6;
    }
</style>

<div class="audit-wrap">
    <div class="audit-muted">internal report (minimal by design)</div>
    <span class="audit-radio" id="auditMode">
        <label class="audit-muted">
            <input type="radio" name="audit_mode" value="with_infra" checked />
            infra + GA
        </label>
        <label class="audit-muted">
            <input type="radio" name="audit_mode" value="ga_only" />
            GA only
        </label>
    </span>
    <div class="audit-row">
        <label class="audit-muted">org:</label>
        <select id="orgSelect">
            <option>loading…</option>
        </select>

        <label class="audit-muted">filter:</label>
        <input id="q" placeholder="type repo name..." />

        <span id="stats" class="audit-muted"></span>
        <button id="btnRunAudit" type="button">run org audit</button>
        <button id="btnInitRepos" type="button">init repos (selected org)</button>
        <button id="btnLoadDiagrams" type="button">diagrams</button>
        <div id="pin-wrap" class="pin-wrap" tabindex="0" title="operator pin">
            <div class="pin-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <input id="pin-hidden" type="password" inputmode="numeric" autocomplete="off">
        </div>
        <span id="actionMsg" class="audit-muted"></span>
    </div>

    <table class="audit-table">
        <thead id="thead">
            <tr>
                <th>Repo</th>
                <th>README</th>
                <th>.gitignore</th>
                <th>branches</th>
                <th>ipynb</th>
                <th>py</th>
                <th>tex</th>
                <th>files</th>
                <th>updated</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td colspan="9">loading…</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    const INDEX_URL = "{{ '/reports/index.json' | relative_url }}";
    const DISPATCH_API = "{{ '/api/github/dispatch' | relative_url }}";

    const tbody = document.getElementById("tbody");
    const q = document.getElementById("q");
    const stats = document.getElementById("stats");
    const orgSelect = document.getElementById("orgSelect");

    let rows = [];
    let currentOrg = null;

    // === sort state ===
    let sortKey = null;
    let sortDir = 1; // 1 asc, -1 desc

    function setSortIndicator() {
        const ths = document.querySelectorAll(".audit-table thead th");
        ths.forEach(th => th.classList.remove("sort-asc", "sort-desc"));

        if (!sortKey) return;

        const th = document.querySelector(`.audit-table thead th[data-key="${sortKey}"]`);
        if (th) th.classList.add(sortDir === 1 ? "sort-asc" : "sort-desc");
    }

    function getSortValue(r, key) {
        const v = r[key];

        // bool -> 0/1
        if (typeof v === "boolean") return v ? 1 : 0;

        // numbers
        if (typeof v === "number") return v;

        // dates
        if (key === "pushed_at") return v ? new Date(v).getTime() : 0;

        // strings
        return (v ?? "").toString().toLowerCase();
    }

    function sortArray(arr) {
        if (!sortKey) return arr; // sem sort => deixa como está (default scoreRow já aplicado em rows)
        return arr.slice().sort((a, b) => {
            const va = getSortValue(a, sortKey);
            const vb = getSortValue(b, sortKey);
            if (va < vb) return -1 * sortDir;
            if (va > vb) return 1 * sortDir;
            return 0;
        });
    }

    function td(text, cls = "") {
        const el = document.createElement("td");
        el.textContent = text;
        if (cls) el.className = cls;
        return el;
    }

    function scoreRow(x) {
        // Primeiro os que “faltam” coisas
        return (x.has_readme ? 0 : 2) + (x.has_gitignore ? 0 : 1);
    }
    const thead = document.getElementById("thead");

    function getViewMode() {
        const el = document.querySelector('input[name="audit_mode"]:checked');
        return el ? el.value : "with_infra";
    }

    function getColumns() {
        const mode = getViewMode();

        // define as colunas e como renderizar cada célula
        const COLS_INFRA = [
            { label: "Repo", key: "name", type: "text" },
            { label: "README", key: "has_readme", type: "bool" },
            { label: ".gitignore", key: "has_gitignore", type: "bool" },
            { label: "branches", key: "branches_count", type: "num" },
            { label: "ipynb", key: "notebooks_ipynb", type: "num" },
            { label: "py", key: "files_py", type: "num" },
            { label: "tex", key: "files_tex", type: "num" },
            { label: "files", key: "total_files", type: "num" },
            { label: "updated", key: "pushed_at", type: "date" },
        ];

        const COLS_GA = [
            { label: "GA views (30d)", key: "ga_pageviews_30d", type: "num" },
            { label: "GA clicks (30d)", key: "ga_clicks_30d", type: "num" },
        ];

        if (mode === "ga_only") {
            return [
                { label: "Repo", key: "name", type: "text" },
                ...COLS_GA,
                { label: "updated", key: "pushed_at", type: "date" },
            ];
        }

        // with_infra: mostra infra + GA
        return [
            ...COLS_INFRA.slice(0, 1),
            ...COLS_GA,
            ...COLS_INFRA.slice(1),
        ];
    }

    let sortKey = "name";
    let sortDir = "asc"; // asc/desc

    function renderHeader(cols) {
        const tr = document.createElement("tr");

        cols.forEach(c => {
            const th = document.createElement("th");
            th.textContent = c.label;

            // colunas ordenáveis
            th.style.cursor = "pointer";
            th.title = "click to sort";

            th.addEventListener("click", () => {
                if (sortKey === c.key) sortDir = (sortDir === "asc" ? "desc" : "asc");
                else { sortKey = c.key; sortDir = "asc"; }
                render(); // reusa o mesmo render
            });

            tr.appendChild(th);
        });

        thead.innerHTML = "";
        thead.appendChild(tr);
    }

    function cmp(a, b, type) {
        const dir = (sortDir === "asc") ? 1 : -1;

        const va = a ?? (type === "text" ? "" : 0);
        const vb = b ?? (type === "text" ? "" : 0);

        if (type === "text") return dir * String(va).localeCompare(String(vb));
        if (type === "bool") return dir * ((va === vb) ? 0 : (va ? -1 : 1)); // true primeiro
        if (type === "date") return dir * (String(va).localeCompare(String(vb)));
        // num
        return dir * ((Number(va) || 0) - (Number(vb) || 0));
    }

    function render() {
        const cols = getColumns();
        renderHeader(cols);

        const needle = (q.value || "").trim().toLowerCase();
        const filtered = needle
            ? rows.filter(r =>
                (r.name || "").toLowerCase().includes(needle) ||
                (r.full_name || "").toLowerCase().includes(needle)
            )
            : rows;

        // ordena
        const sortCol = cols.find(c => c.key === sortKey) || cols[0];
        filtered.sort((A, B) => cmp(A[sortCol.key], B[sortCol.key], sortCol.type));

        tbody.innerHTML = "";

        if (!filtered.length) {
            const tr = document.createElement("tr");
            tr.appendChild(td("no repos found"));
            for (let i = 0; i < cols.length - 1; i++) tr.appendChild(td(""));
            tbody.appendChild(tr);
            return;
        }

        for (const r of filtered) {
            const tr = document.createElement("tr");

            cols.forEach(c => {
                if (c.key === "name") {
                    const repoCell = document.createElement("td");
                    const a = document.createElement("a");
                    a.href = r.url;
                    a.textContent = r.name;
                    a.target = "_blank";
                    a.rel = "noreferrer";
                    repoCell.appendChild(a);
                    tr.appendChild(repoCell);
                    return;
                }

                if (c.type === "bool") {
                    const v = !!r[c.key];
                    tr.appendChild(td(v ? "yes" : "no", v ? "audit-ok" : "audit-no"));
                    return;
                }

                if (c.type === "date") {
                    tr.appendChild(td((r[c.key] || "").slice(0, 10)));
                    return;
                }

                tr.appendChild(td(String(r[c.key] ?? 0)));
            });

            tbody.appendChild(tr);
        }
    }

    function loadOrg(org) {
        window.resetOperatorPin?.();
        currentOrg = org;

        const INFRA_URL = `{{ '/reports/' | relative_url }}${org}/org-audit.json`;
        const GA_URL = `{{ '/reports/' | relative_url }}${org}/ga-usage.json`;

        tbody.innerHTML = `<tr><td colspan="9">loading ${org}…</td></tr>`;
        q.value = "";

        Promise.all([
            fetch(INFRA_URL, { cache: "no-store" }).then(r => (r.ok ? r.json() : null)),
            fetch(GA_URL, { cache: "no-store" }).then(r => (r.ok ? r.json() : null)),
        ])
            .then(([infra, ga]) => {
                rows = infra || [];

                const pv = (ga && ga.pageviews_by_path) ? ga.pageviews_by_path : {};
                const ck = (ga && ga.clicks_by_path) ? ga.clicks_by_path : {};

                // anexa GA por repo (heurística simples):
                // repo page no GitHub Pages costuma ser "/<repo>/" ou "/<repo>"
                for (const r of rows) {
                    const slug = r.name || "";
                    const k1 = `/${slug}/`;
                    const k2 = `/${slug}`;
                    r.ga_pageviews_30d = pv[k1] ?? pv[k2] ?? 0;
                    r.ga_clicks_30d = ck[k1] ?? ck[k2] ?? 0;
                }

                rows.sort((a, b) => scoreRow(b) - scoreRow(a) || (a.name || "").localeCompare(b.name || ""));
                render();

                try { localStorage.setItem("audit_org", org); } catch (_) { }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="9">failed to load ${org}: ${String(err)}</td></tr>`;
            });
    }

    q.addEventListener("input", render);

    fetch(INDEX_URL, { cache: "no-store" })
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(idx => {
            const orgs = (idx && idx.orgs) ? idx.orgs : [];
            orgSelect.innerHTML = "";

            if (!orgs.length) {
                orgSelect.innerHTML = `<option>(no orgs in index.json)</option>`;
                tbody.innerHTML = `<tr><td colspan="9">reports/index.json has no orgs</td></tr>`;
                return;
            }

            for (const org of orgs) {
                const opt = document.createElement("option");
                opt.value = org;
                opt.textContent = org;
                orgSelect.appendChild(opt);
            }

            // escolhe org (localStorage -> primeira)
            let preferred = null;
            try { preferred = localStorage.getItem("audit_org"); } catch (_) { }
            const initial = (preferred && orgs.includes(preferred)) ? preferred : orgs[0];

            orgSelect.value = initial;
            loadOrg(initial);
        })
        .catch(err => {
            tbody.innerHTML = `<tr><td colspan="9">failed to load ${INDEX_URL}: ${String(err)}</td></tr>`;
        });

    orgSelect.addEventListener("change", () => loadOrg(orgSelect.value));

    const btnRunAudit = document.getElementById("btnRunAudit");
    const btnInitRepos = document.getElementById("btnInitRepos");
    const btnLoadDiagrams = document.getElementById("btnLoadDiagrams");
    const actionMsg = document.getElementById("actionMsg");

    function setBusy(busy, msg = "") {
        btnRunAudit.disabled = busy;
        btnInitRepos.disabled = busy;
        actionMsg.textContent = msg || "";
    }

    async function postJSON(url, payload) {
        const r = await fetch(url, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
        });
        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) { }
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text || r.statusText}`);
        return data;
    }

    // 1) Dispara auditoria (ex: workflow org-audit no repo central "hub" ou ".github")
    btnRunAudit?.addEventListener("click", async () => {
        try {
            const pin = window.getOperatorPin?.() || "";
            if (pin.length !== 4) {
                window.openOperatorPin?.(btnRunAudit);  // foco + arma esse botão
                setBusy(false, "enter 4-digit pin");
                return;
            }
            setBusy(true, "dispatching org audit…");

            // Ajuste para o seu repo central que contém o workflow org-audit.yml
            // Ex: org=naavilam, repo=hub, workflow=org-audit.yml
            // regra:
            // - with_infra => run_infra=true, run_ga=true (ou false se você quiser)
            // - ga_only    => run_infra=false, run_ga=true
            const mode = getAuditMode();
            const run_infra = (mode === "with_infra");
            const run_ga = true; // aqui você decide: sempre GA quando clicar "run org audit"

            const payload = {
                action: "workflow_dispatch",
                org: "naavilam",     // repo central que contém o workflow
                repo: "hub",
                workflow: "audit.yml",
                ref: "main",
                inputs: {
                    run_infra,
                    run_ga,
                    orgs: orgSelect.value // roda só a org selecionada
                }
            };

            if ((window.getOperatorPin() || "").length !== 4) {
                setBusy(false, "enter 4-digit pin");
                return;
            }
            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();

            setBusy(false, out?.message || "ok: audit dispatched");
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    // 2) Dispara inicializa-repos.yml no .github da org selecionada
    btnInitRepos?.addEventListener("click", async () => {
        try {

            const pin = window.getOperatorPin?.() || "";
            if (pin.length !== 4) {
                window.openOperatorPin?.(btnInitRepos);  // foco + arma esse botão
                setBusy(false, "enter 4-digit pin");
                return;
            }

            const org = orgSelect.value;
            if (!org) return;

            setBusy(true, `dispatching inicializa-repos for ${org}…`);

            const payload = {
                action: "workflow_dispatch",
                org,                // org selecionada na UI
                repo: ".github",    // workflow está em org/.github
                workflow: "inicializa-repos.yml",
                ref: "main",
                inputs: {
                    mode: "all",
                    org: org,
                    repo: ""          // porque seu workflow aceita repo quando mode=one
                },
                pin: pin
            };

            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();
            setBusy(false, out?.message || `ok: inicializa-repos dispatched for ${org}`);
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    btnLoadDiagrams?.addEventListener("click", async () => {
        window.resetOperatorPin?.();
        window.location.href = "./svg-gallery.html";
    });

    // === PIN fancy logic (isolado) ===
    (() => {
        const wrap = document.getElementById("pin-wrap");
        const input = document.getElementById("pin-hidden");
        if (!wrap || !input) return;

        const dots = [...wrap.querySelectorAll(".dot")];
        const MAX = dots.length;

        let armedButton = null; // guarda qual botão pediu o PIN

        function renderPin() {
            dots.forEach((d, i) =>
                d.classList.toggle("filled", i < input.value.length)
            );
        }

        function openPin(btn = null) {
            armedButton = btn || armedButton;
            wrap.classList.add("is-open");
            // micro delay pra garantir foco mesmo após click
            setTimeout(() => input.focus(), 0);
        }

        function closePin() {
            armedButton = null;
            input.value = "";
            dots.forEach(d => d.classList.remove("filled"));
            input.blur();
            wrap.classList.remove("is-open"); // some da tela
            actionMsg.textContent = "";
        }

        wrap.addEventListener("click", () => openPin());

        input.addEventListener("input", () => {
            input.value = input.value.replace(/\D/g, "").slice(0, MAX);
            renderPin();
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace") {
                input.value = input.value.slice(0, -1);
                renderPin();
                e.preventDefault();
                return;
            }

            if (e.key === "Enter") {
                // se completou o PIN, dispara o botão que armou
                if (input.value.length === MAX && armedButton) {
                    armedButton.click();
                }
                e.preventDefault();
            }

            if (e.key === "Escape") {
                closePin();
                e.preventDefault();
            }
        });

        window.getOperatorPin = () => input.value;
        window.openOperatorPin = (btn) => openPin(btn);
        window.resetOperatorPin = () => closePin();
    })();

    function getAuditMode() {
        const el = document.querySelector('input[name="audit_mode"]:checked');
        return el ? el.value : "with_infra";
    }

    document.getElementById("auditMode")?.addEventListener("change", () => render());

    // === make headers sortable ===
    (() => {
        const map = [
            ["Repo", "name"],
            ["README", "has_readme"],
            [".gitignore", "has_gitignore"],
            ["branches", "branches_count"],
            ["ipynb", "notebooks_ipynb"],
            ["py", "files_py"],
            ["tex", "files_tex"],
            ["files", "total_files"],
            ["updated", "pushed_at"],
        ];

        const ths = document.querySelectorAll(".audit-table thead th");
        ths.forEach((th, i) => {
            const key = map[i]?.[1];
            if (!key) return;
            th.dataset.key = key;

            th.addEventListener("click", () => {
                if (sortKey === key) sortDir = -sortDir;
                else { sortKey = key; sortDir = 1; }

                setSortIndicator();
                render();
            });
        });
    })();
</script>