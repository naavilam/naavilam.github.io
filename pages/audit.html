---
layout: page
permalink: /audit.html
title: Audit
description: Internal repository report
---

<style>
    /* intencionalmente feio/mono, mas sem quebrar o layout do site */
    .audit-wrap {
        font-family: ui-monospace, Menlo, Consolas, monospace;
    }

    .audit-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin: 10px 0 14px;
    }

    .audit-row input,
    .audit-row select {
        max-width: 100%;
        padding: 6px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
    }

    .audit-row input {
        width: 320px;
    }

    .audit-row select {
        width: 360px;
    }

    .audit-muted {
        color: #444;
        font-size: 12px;
    }

    .audit-table {
        border-collapse: collapse;
        width: 100%;
    }

    .audit-table th,
    .audit-table td {
        border: 1px solid #000;
        padding: 6px 8px;
        font-size: 12px;
        vertical-align: top;
    }

    .audit-table th {
        background: #f2f2f2;
    }

    .audit-ok {
        background: #eaffea;
    }

    .audit-no {
        background: #ffecec;
    }

    .audit-row button {
        padding: 6px 10px;
        border: 1px solid #000;
        background: #fff;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
    }

    .audit-row button:disabled {
        opacity: .5;
        cursor: not-allowed;
    }

    /* === PIN fancy (minimal) === */
    .pin-wrap {
        display: inline-flex;
        align-items: center;
        padding: 6px 8px;
        border: 1px solid #000;
        cursor: text;
    }

    .pin-dots {
        display: flex;
        gap: 6px;
    }

    .pin-dots .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
    }

    .pin-dots .dot.filled {
        background: #000;
    }

    #pin-hidden {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .pin-wrap {
        display: none;
        /* override do inline-flex */
    }

    .pin-wrap.is-open {
        display: inline-flex;
    }

    .audit-radio {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        margin-left: 10px;
    }

    .audit-radio label {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .audit-radio input[type="radio"] {
        transform: translateY(1px);
    }

    .audit-table th {
        cursor: pointer;
        user-select: none;
    }

    .audit-table th.sort-asc::after {
        content: " ↑";
        opacity: 0.6;
    }

    .audit-table th.sort-desc::after {
        content: " ↓";
        opacity: 0.6;
    }
</style>

<div class="audit-wrap">
    <div class="audit-muted">internal report (minimal by design)</div>
    <span class="audit-radio" id="auditMode">
        <label class="audit-muted">
            <input type="radio" name="audit_mode" value="with_infra" checked />
            infra
        </label>
        <label class="audit-muted">
            <input type="radio" name="audit_mode" value="ga_only" />
            analytics
        </label>
    </span>
    <div class="audit-row">
        <label class="audit-muted">org:</label>
        <select id="orgSelect">
            <option>loading…</option>
        </select>

        <label class="audit-muted">filter:</label>
        <input id="q" placeholder="type repo name..." />

        <span id="stats" class="audit-muted"></span>
        <button id="btnRunAudit" type="button">run org audit</button>
        <button id="btnInitRepos" type="button">init repos (selected org)</button>
        <button id="btnLoadDiagrams" type="button">diagrams</button>
        <div id="pin-wrap" class="pin-wrap" tabindex="0" title="operator pin">
            <div class="pin-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <input id="pin-hidden" type="password" inputmode="numeric" autocomplete="off">
        </div>
        <span id="actionMsg" class="audit-muted"></span>
    </div>

    <table class="audit-table">
        <thead id="thead">
            <tr>
                <th>Repo</th>
                <th>README</th>
                <th>.gitignore</th>
                <th>branches</th>
                <th>ipynb</th>
                <th>py</th>
                <th>tex</th>
                <th>files</th>
                <th>updated</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td colspan="9">loading…</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    const INDEX_URL = "{{ '/reports/index.json' | relative_url }}";
    const DISPATCH_API = "{{ '/api/github/dispatch' | relative_url }}";

    const tbody = document.getElementById("tbody");
    const thead = document.getElementById("thead");
    const q = document.getElementById("q");
    const stats = document.getElementById("stats");
    const orgSelect = document.getElementById("orgSelect");

    const btnRunAudit = document.getElementById("btnRunAudit");
    const btnInitRepos = document.getElementById("btnInitRepos");
    const btnLoadDiagrams = document.getElementById("btnLoadDiagrams");
    const actionMsg = document.getElementById("actionMsg");

    let rows = [];
    let currentOrg = null;

    // sort state (UMA SÓ VEZ)
    let sortKey = "name";
    let sortDir = "asc"; // "asc" | "desc"

    function td(text, cls = "") {
        const el = document.createElement("td");
        el.textContent = text;
        if (cls) el.className = cls;
        return el;
    }

    function scoreRow(x) {
        return (x.has_readme ? 0 : 2) + (x.has_gitignore ? 0 : 1);
    }

    function getAuditMode() {
        const el = document.querySelector('input[name="audit_mode"]:checked');
        return el ? el.value : "with_infra";
    }

    function getColumns() {
        const mode = getAuditMode();

        const COLS_INFRA = [
            { label: "Repo", key: "name", type: "text" },
            { label: "README", key: "has_readme", type: "bool" },
            { label: ".gitignore", key: "has_gitignore", type: "bool" },
            { label: "branches", key: "branches_count", type: "num" },
            { label: "ipynb", key: "notebooks_ipynb", type: "num" },
            { label: "py", key: "files_py", type: "num" },
            { label: "tex", key: "files_tex", type: "num" },
            { label: "files", key: "total_files", type: "num" },
            { label: "updated", key: "pushed_at", type: "date" },
        ];

        const COLS_GA = [
            { label: "Repo", key: "name", type: "text" },
            { label: "views (30d)", key: "ga_pageviews_30d", type: "num" },
            { label: "clicks (30d)", key: "ga_clicks_30d", type: "num" },
            { label: "updated", key: "pushed_at", type: "date" },
        ];

        return (mode === "ga_only") ? COLS_GA : COLS_INFRA;
    }

    function renderHeader(cols) {
        const tr = document.createElement("tr");

        cols.forEach(c => {
            const th = document.createElement("th");
            th.textContent = c.label;
            th.dataset.key = c.key;
            th.style.cursor = "pointer";
            th.title = "click to sort";

            // setinhas
            th.classList.remove("sort-asc", "sort-desc");
            if (c.key === sortKey) th.classList.add(sortDir === "asc" ? "sort-asc" : "sort-desc");

            th.addEventListener("click", () => {
                if (sortKey === c.key) sortDir = (sortDir === "asc" ? "desc" : "asc");
                else { sortKey = c.key; sortDir = "asc"; }
                render();
            });

            tr.appendChild(th);
        });

        thead.innerHTML = "";
        thead.appendChild(tr);
    }

    function cmp(a, b, type) {
        const dir = (sortDir === "asc") ? 1 : -1;

        if (type === "text") {
            return dir * String(a ?? "").localeCompare(String(b ?? ""));
        }
        if (type === "bool") {
            const va = !!a, vb = !!b;
            // true primeiro no asc (fica mais útil)
            if (va === vb) return 0;
            return dir * (va ? -1 : 1);
        }
        if (type === "date") {
            const ta = a ? new Date(a).getTime() : 0;
            const tb = b ? new Date(b).getTime() : 0;
            return dir * (ta - tb);
        }
        // num
        return dir * ((Number(a) || 0) - (Number(b) || 0));
    }

    function setBusy(busy, msg = "") {
        btnRunAudit.disabled = busy;
        btnInitRepos.disabled = busy;
        actionMsg.textContent = msg || "";
    }

    function render() {
        const cols = getColumns();
        renderHeader(cols);

        const needle = (q.value || "").trim().toLowerCase();
        const filtered = needle
            ? rows.filter(r =>
                (r.name || "").toLowerCase().includes(needle) ||
                (r.full_name || "").toLowerCase().includes(needle)
            )
            : rows.slice();

        // stats
        const total = rows.length;
        const shown = filtered.length;
        const withReadme = filtered.filter(r => r.has_readme).length;
        const withGitignore = filtered.filter(r => r.has_gitignore).length;
        const ipynb = filtered.reduce((s, r) => s + (r.notebooks_ipynb || 0), 0);
        const gaViews = filtered.reduce((s, r) => s + (r.ga_pageviews_30d || 0), 0);
        const gaClicks = filtered.reduce((s, r) => s + (r.ga_clicks_30d || 0), 0);

        const mode = getAuditMode();

        if (mode === "ga_only") {
            stats.textContent =
                `org=${currentOrg || "—"} | showing ${shown}/${total} | GA views ${gaViews} | GA clicks ${gaClicks}`;
        } else {
            stats.textContent =
                `org=${currentOrg || "—"} | showing ${shown}/${total} | README ${withReadme} | gitignore ${withGitignore} | ipynb ${ipynb}`;
        }
        // sort
        const sortCol = cols.find(c => c.key === sortKey) || cols[0];
        filtered.sort((A, B) => cmp(A[sortCol.key], B[sortCol.key], sortCol.type));

        // body
        tbody.innerHTML = "";

        if (!filtered.length) {
            const tr = document.createElement("tr");
            tr.appendChild(td("no repos found"));
            for (let i = 0; i < cols.length - 1; i++) tr.appendChild(td(""));
            tbody.appendChild(tr);
            return;
        }

        const gaViewsVals = filtered.map(r => r.ga_pageviews_30d || 0);
        const gaClicksVals = filtered.map(r => r.ga_clicks_30d || 0);

        const gaViewsMin = Math.min(...gaViewsVals);
        const gaViewsMax = Math.max(...gaViewsVals);

        const gaClicksMin = Math.min(...gaClicksVals);
        const gaClicksMax = Math.max(...gaClicksVals);

        for (const r of filtered) {
            const tr = document.createElement("tr");

            cols.forEach(c => {
                if (c.key === "name") {
                    const repoCell = document.createElement("td");
                    const a = document.createElement("a");
                    a.href = r.url;
                    a.textContent = r.name;
                    a.target = "_blank";
                    a.rel = "noreferrer";
                    repoCell.appendChild(a);
                    tr.appendChild(repoCell);
                    return;
                }

                if (c.type === "bool") {
                    const v = !!r[c.key];
                    tr.appendChild(td(v ? "yes" : "no", v ? "audit-ok" : "audit-no"));
                    return;
                }

                if (c.type === "date") {
                    tr.appendChild(td((r[c.key] || "").slice(0, 10)));
                    return;
                }

                if (c.key === "ga_pageviews_30d" || c.key === "ga_clicks_30d") {
                    const value = Number(r[c.key] ?? 0);

                    const min = (c.key === "ga_pageviews_30d") ? gaViewsMin : gaClicksMin;
                    const max = (c.key === "ga_pageviews_30d") ? gaViewsMax : gaClicksMax;

                    const cell = td(String(value), "audit-ga");

                    if (value === 0) {
                        cell.style.color = "#b00020"; // zero = alerta forte
                    } else {
                        cell.style.color = gaColor(value, min, max);
                    }

                    tr.appendChild(cell);
                    return;
                }
            });

            tbody.appendChild(tr);
        }
    }

    function loadOrg(org) {
        window.resetOperatorPin?.();
        currentOrg = org;

        const INFRA_URL = `{{ '/reports/' | relative_url }}${org}/org-audit.json`;
        const GA_URL = `{{ '/reports/' | relative_url }}${org}/ga-usage.json`;

        tbody.innerHTML = `<tr><td colspan="9">loading ${org}…</td></tr>`;
        q.value = "";

        Promise.all([
            fetch(INFRA_URL, { cache: "no-store" }).then(r => (r.ok ? r.json() : [])),
            fetch(GA_URL, { cache: "no-store" }).then(r => (r.ok ? r.json() : null)),
        ])
            .then(([infra, ga]) => {
                rows = (infra || []).slice();

                const pv = (ga && ga.pageviews_by_path) ? ga.pageviews_by_path : {};
                const ck = (ga && ga.clicks_by_path) ? ga.clicks_by_path : {};

                for (const r of rows) {
                    const slug = r.name || "";
                    const k1 = `/${slug}/`;
                    const k2 = `/${slug}`;
                    r.ga_pageviews_30d = pv[k1] ?? pv[k2] ?? 0;
                    r.ga_clicks_30d = ck[k1] ?? ck[k2] ?? 0;
                }

                // ordenação “default” (antes do sort por header)
                rows.sort((a, b) => scoreRow(b) - scoreRow(a) || (a.name || "").localeCompare(b.name || ""));

                // se o sort atual não existe nas colunas do modo atual, volta pro name
                const cols = getColumns();
                if (!cols.some(c => c.key === sortKey)) sortKey = "name";

                render();

                try { localStorage.setItem("audit_org", org); } catch (_) { }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="9">failed to load ${org}: ${String(err)}</td></tr>`;
            });
    }

    q.addEventListener("input", render);

    // radio: muda view (infra+GA vs GA only) sem recarregar
    document.getElementById("auditMode")?.addEventListener("change", () => {
        const cols = getColumns();
        if (!cols.some(c => c.key === sortKey)) sortKey = "name";
        render();
    });

    // carregar lista de orgs
    fetch(INDEX_URL, { cache: "no-store" })
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(idx => {
            const orgs = (idx && idx.orgs) ? idx.orgs : [];
            orgSelect.innerHTML = "";

            if (!orgs.length) {
                orgSelect.innerHTML = `<option>(no orgs in index.json)</option>`;
                tbody.innerHTML = `<tr><td colspan="9">reports/index.json has no orgs</td></tr>`;
                return;
            }

            for (const org of orgs) {
                const opt = document.createElement("option");
                opt.value = org;
                opt.textContent = org;
                orgSelect.appendChild(opt);
            }

            let preferred = null;
            try { preferred = localStorage.getItem("audit_org"); } catch (_) { }
            const initial = (preferred && orgs.includes(preferred)) ? preferred : orgs[0];

            orgSelect.value = initial;
            loadOrg(initial);
        })
        .catch(err => {
            tbody.innerHTML = `<tr><td colspan="9">failed to load ${INDEX_URL}: ${String(err)}</td></tr>`;
        });

    orgSelect.addEventListener("change", () => loadOrg(orgSelect.value));

    async function postJSON(url, payload) {
        const r = await fetch(url, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
        });
        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) { }
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text || r.statusText}`);
        return data;
    }

    btnRunAudit?.addEventListener("click", async () => {
        try {
            const pin = window.getOperatorPin?.() || "";
            if (pin.length !== 4) {
                window.openOperatorPin?.(btnRunAudit);
                setBusy(false, "enter 4-digit pin");
                return;
            }

            setBusy(true, "dispatching org audit…");

            const mode = getAuditMode();
            const run_infra = (mode === "with_infra");
            const run_ga = true;

            const payload = {
                action: "workflow_dispatch",
                org: "naavilam",
                repo: "hub",
                workflow: "audit.yml",
                ref: "main",
                inputs: {
                    run_infra,
                    run_ga,
                    orgs: orgSelect.value
                }
            };

            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();
            setBusy(false, out?.message || "ok: audit dispatched");
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    btnInitRepos?.addEventListener("click", async () => {
        try {
            const pin = window.getOperatorPin?.() || "";
            if (pin.length !== 4) {
                window.openOperatorPin?.(btnInitRepos);
                setBusy(false, "enter 4-digit pin");
                return;
            }

            const org = orgSelect.value;
            if (!org) return;

            setBusy(true, `dispatching inicializa-repos for ${org}…`);

            const payload = {
                action: "workflow_dispatch",
                org,
                repo: ".github",
                workflow: "inicializa-repos.yml",
                ref: "main",
                inputs: { mode: "all", org, repo: "" },
                pin
            };

            const out = await postJSON(DISPATCH_API, payload);
            window.resetOperatorPin?.();
            setBusy(false, out?.message || `ok: inicializa-repos dispatched for ${org}`);
        } catch (e) {
            window.resetOperatorPin?.();
            setBusy(false, `failed: ${String(e)}`);
        }
    });

    btnLoadDiagrams?.addEventListener("click", async () => {
        window.resetOperatorPin?.();
        window.location.href = "./svg-gallery.html";
    });

    // === PIN fancy logic (igual ao seu) ===
    (() => {
        const wrap = document.getElementById("pin-wrap");
        const input = document.getElementById("pin-hidden");
        if (!wrap || !input) return;

        const dots = [...wrap.querySelectorAll(".dot")];
        const MAX = dots.length;

        let armedButton = null;

        function renderPin() {
            dots.forEach((d, i) => d.classList.toggle("filled", i < input.value.length));
        }

        function openPin(btn = null) {
            armedButton = btn || armedButton;
            wrap.classList.add("is-open");
            setTimeout(() => input.focus(), 0);
        }

        function closePin() {
            armedButton = null;
            input.value = "";
            dots.forEach(d => d.classList.remove("filled"));
            input.blur();
            wrap.classList.remove("is-open");
            actionMsg.textContent = "";
        }

        wrap.addEventListener("click", () => openPin());

        input.addEventListener("input", () => {
            input.value = input.value.replace(/\D/g, "").slice(0, MAX);
            renderPin();
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace") {
                input.value = input.value.slice(0, -1);
                renderPin();
                e.preventDefault();
                return;
            }
            if (e.key === "Enter") {
                if (input.value.length === MAX && armedButton) armedButton.click();
                e.preventDefault();
            }
            if (e.key === "Escape") {
                closePin();
                e.preventDefault();
            }
        });

        window.getOperatorPin = () => input.value;
        window.openOperatorPin = (btn) => openPin(btn);
        window.resetOperatorPin = () => closePin();
    })();

    function gaColor(value, min, max) {
        if (max <= min) return ""; // evita divisão por zero

        const t = (value - min) / (max - min); // 0..1

        // gradiente: vermelho -> amarelo -> verde
        const r = Math.round(180 * (1 - t));
        const g = Math.round(180 * t);
        const b = 0;

        return `rgb(${r}, ${g}, ${b})`;
    }
</script>