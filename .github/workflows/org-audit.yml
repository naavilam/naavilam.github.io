name: Audit (infra + GA)

on:
  workflow_dispatch:
    inputs:
      run_infra:
        description: "Run infra audit"
        type: boolean
        default: true
      run_ga:
        description: "Run GA usage audit"
        type: boolean
        default: false
      orgs:
        description: "Comma-separated orgs (leave empty to use default ORGS env)"
        type: string
        default: ""
  schedule:
    - cron: "17 3 * * *" # di√°rio (UTC)

permissions:
  contents: write

env:
  ORGS: academic-codex,quantum-materials-simulation-research,high-energy-physics-research,quantum-computing-research

jobs:
  audit_infra:
    if: ${{ github.event_name == 'schedule' || inputs.run_infra }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run infra audit
        env:
          ORGS: ${{ inputs.orgs != '' && inputs.orgs || env.ORGS }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/org_audit.py

      - name: Upload reports artifact (infra)
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports

  audit_ga:
    if: ${{ github.event_name == 'schedule' || inputs.run_ga }}
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install google-analytics-data

      - name: Run GA usage audit
        env:
          ORGS: ${{ inputs.orgs != '' && inputs.orgs || env.ORGS }}
          GA_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS_JSON }}

          GA_PROPERTY_ID_ACADEMIC_CODEX: ${{ vars.GA_PROPERTY_ID_ACADEMIC_CODEX }}
          GA_PROPERTY_ID_HIGH_ENERGY_PHYSICS_RESEARCH: ${{ vars.GA_PROPERTY_ID_HIGH_ENERGY_PHYSICS_RESEARCH }}
          GA_PROPERTY_ID_NAAVILAM: ${{ vars.GA_PROPERTY_ID_NAAVILAM }}
          GA_PROPERTY_ID_QUANTUM_MATERIALS_SIMULATION_RESEARCH: ${{ vars.GA_PROPERTY_ID_QUANTUM_MATERIALS_SIMULATION_RESEARCH }}
          GA_PROPERTY_ID_QUANTUM_COMPUTING_RESEARCH: ${{ vars.GA_PROPERTY_ID_QUANTUM_MATERIALS_SIMULATION_RESEARCH }} #FIX
        run: |
          python .github/scripts/ga_audit_usage.py

      - name: Upload reports artifact (ga)
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports

  commit_reports:
    if: ${{ always() && (needs.audit_infra.result != 'skipped' || needs.audit_ga.result != 'skipped') }}
    runs-on: ubuntu-latest
    needs: [audit_infra, audit_ga]
    steps:
      - uses: actions/checkout@v4

      - name: Download reports artifact
        uses: actions/download-artifact@v4
        with:
          name: reports
          path: reports

      - name: Commit reports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports
          git commit -m "Update reports (infra/ga)" || echo "No changes"
          git push